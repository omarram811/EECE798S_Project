<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>{{ agent.name }} — Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <span class="text-xs text-gray-500">ID: {{ agent.id }}</span>

  <div class="max-w-4xl mx-auto p-6">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-xl font-semibold">{{ agent.name }}</h1>
      <a class="text-sm text-gray-600 underline" href="/dashboard">Back</a>
    </div>

    <form action="/agents/{{agent.id}}/update" method="post" class="bg-white rounded shadow p-4 mb-4">
      <h2 class="font-semibold mb-2">Agent Settings</h2>
      <div class="grid md:grid-cols-3 gap-3">
        <input class="border p-2" name="name" value="{{agent.name}}"/>
        <input class="border p-2" name="drive_folder" value="{{agent.drive_folder_id or ''}}" placeholder="Drive folder URL or ID"/>
        <input class="border p-2" name="persona" value="{{agent.persona}}"/>
        <select class="border p-2" name="provider">
          <option {% if agent.provider=='openai' %}selected{% endif %} value="openai">OpenAI</option>
          <option {% if agent.provider=='gemini' %}selected{% endif %} value="gemini">Gemini</option>
        </select>
        <input class="border p-2" name="model" value="{{agent.model}}"/>
        <input class="border p-2" name="embed_model" value="{{agent.embed_model}}"/>
      </div>
      <div class="text-right mt-2">
        <button class="px-3 py-1 bg-gray-800 text-white rounded">Save</button>
      </div>
    </form>

    <div id="messages" class="bg-white rounded shadow p-4 min-h-[300px] space-y-3">
      {% for m in messages %}
        <div class="whitespace-pre-wrap">
          <span class="text-xs uppercase text-gray-400">{{m.role}}</span><br/>
          {{ m.content }}
        </div>
      {% endfor %}
    </div>

    <form id="promptForm" action="/chat/{{agent.id}}" method="post" class="mt-3 flex gap-2">
      <input id="prompt" class="flex-1 border p-2 rounded" name="prompt" placeholder="Ask something about the course..." />
      <button class="px-4 py-2 rounded bg-indigo-600 text-white">Send</button>
    </form>

  </div>

  <script>
  const messages = document.getElementById('messages');
  const form = document.getElementById('promptForm');
  let es = null;            // the single EventSource
  let streamingEl = null;   // <span id="streaming"> for the current answer

  function closeStream() {
    if (es) {
      es.close();
      es = null;
    }
  }

  function startStream() {
    // always close any previous stream first
    closeStream();

    es = new EventSource('/chat/{{agent.id}}/stream');

    es.addEventListener('message', (e) => {
      // lazily create the streaming bubble once
      if (!streamingEl) {
        const div = document.createElement('div');
        div.className = 'whitespace-pre-wrap';
        div.innerHTML = '<span class="text-xs uppercase text-gray-400">assistant</span><br/><span id="streaming"></span>';
        messages.appendChild(div);
        streamingEl = div.querySelector('#streaming');
      }
      streamingEl.textContent += e.data;
      messages.scrollTop = messages.scrollHeight;
    });

    es.addEventListener('done', () => {
      // finalize the bubble and STOP auto-reconnect loops
      if (streamingEl) streamingEl.removeAttribute('id');
      streamingEl = null;
      closeStream();
    });

    // Optional: server may emit [BUSY] (from backend debounce). Just close.
    es.addEventListener('info', () => {
      closeStream();
    });

    // Network/server restarts, etc. Don’t auto-retry here; wait for user action.
    es.addEventListener('error', () => {
      closeStream();
    });
  }

  // Start one stream on page load. Backend will send [IDLE] if there’s nothing to answer.
  startStream();

  // Prevent overlapping streams during navigation / form submit
  form.addEventListener('submit', () => {
    // You can also optimistically append the user message here if you want.
    closeStream(); // stop the current stream before POST + redirect
  });
  </script>

</body>
</html>
