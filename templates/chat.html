<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ agent.name }} ‚Äî Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Custom Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            aub: "#840032",
            aubLight: "#f7e6eb"
          }
        }
      }
    }
  </script>

  <style>
    .user-msg {
      background: #840032;
      color: white;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 80%;
      margin-left: auto;
    }
    .assistant-msg {
      background: #f3f3f3;
      color: #333;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 80%;
      margin-right: auto;
      border: 1px solid #ddd;
    }
    .btn-round {
      width: 50px;
      height: 50px;
      background-color: #840032;
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      transition: 0.2s;
    }
    .btn-round:hover {
      background-color: #5a0024;
    }
  </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen">

<header class="flex justify-between items-center p-6 bg-white shadow-md">

  <a href="/dashboard"
    class="flex items-center text-gray-600 hover:text-aub transition text-4xl font-bold mr-4">
    ‚Üê
  </a>


  <h1 class="text-3xl font-bold text-gray-800">{{ agent.name }}</h1>

  <img src="/static/logos.png" alt="Logo" class="h-20 w-auto">
</header>


  <main class="max-w-4xl mx-auto p-6 space-y-6">


    <!-- Agent Settings -->
    <form action="/agents/{{agent.id}}/update" method="post" class="bg-white rounded-xl shadow-md p-6 space-y-4 border border-aub/30">
      <h2 class="text-xl font-semibold text-aub">Agent Settings</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <input class="border rounded p-3 text-lg" name="name" value="{{agent.name}}" />
        <input class="border rounded p-3 text-lg" name="drive_folder" value="{{agent.drive_folder_id or ''}}" placeholder="Drive folder URL or ID"/>
        <input class="border rounded p-3 text-lg" name="persona" value="{{agent.persona}}" placeholder="Persona / Description"/>
        <select class="border rounded p-3 text-lg" name="provider">
          <option {% if agent.provider=='openai' %}selected{% endif %} value="openai">OpenAI</option>
          <option {% if agent.provider=='gemini' %}selected{% endif %} value="gemini">Gemini</option>
        </select>
        <input class="border rounded p-3 text-lg" name="model" value="{{agent.model}}" placeholder="Model"/>
        <input class="border rounded p-3 text-lg" name="embed_model" value="{{agent.embed_model}}" placeholder="Embedding Model"/>
      </div>
      <div class="text-right">
        <button class="bg-aub text-white px-6 py-2 rounded-xl hover:bg-aub/80">Save</button>
      </div>
    </form>

    <!-- Chat Messages -->
    <div id="messages" class="bg-white rounded-xl shadow-md p-6 min-h-[300px] space-y-3 overflow-y-auto border border-aub/20">
      {% for m in messages %}
        <div class="{% if m.role=='user' %}user-msg{% else %}assistant-msg{% endif %}">
          {{ m.content }}
        </div>
      {% endfor %}
    </div>

    <!-- Chat Input -->
    <form id="promptForm" action="/chat/{{agent.id}}" method="post" class="mt-3 flex gap-3 items-center">

      <!-- Mic Button (Start Recording Only) -->
      <button type="button" id="voice-btn" class="btn-round">üé§</button>

      <!-- Input -->
      
      <textarea id="prompt"
        class="flex-1 border rounded-xl p-3 text-lg resize-none overflow-hidden"
        name="prompt"
        placeholder="Type your message..."
        rows="1"
      ></textarea>


      <!-- Send Button -->
      <button class="btn-round" type="submit">‚û§</button>

    </form>
  </main>

  <script>
    // Streaming logic
    const messages = document.getElementById('messages');
    const form = document.getElementById('promptForm');
    let es = null;
    let streamingEl = null;

    function closeStream() { if (es) { es.close(); es = null; } }

    function startStream() {
      closeStream();
      es = new EventSource('/chat/{{agent.id}}/stream');

      es.addEventListener('message', (e) => {
        if (!streamingEl) {
          const div = document.createElement('div');
          div.className = 'assistant-msg';
          div.innerHTML = '<span id="streaming"></span>';
          messages.appendChild(div);
          streamingEl = div.querySelector('#streaming');
        }
        streamingEl.textContent += e.data;
        messages.scrollTop = messages.scrollHeight;
      });

      es.addEventListener('done', () => {
        if (streamingEl) streamingEl.removeAttribute('id');
        streamingEl = null;
        closeStream();
      });
    }

    startStream();
    form.addEventListener('submit', closeStream);

    let recognition = null;
    const promptInput = document.getElementById('prompt');
    const autoResize = () => {
    promptInput.style.height = "auto";
    promptInput.style.height = promptInput.scrollHeight + "px";
  };

    const voiceBtn = document.getElementById('voice-btn');
    let recognizing = false;

    let lastInterim = "";
    let finalText = "";

    function longestCommonPrefix(a, b) {
      let i = 0;
      while (i < a.length && i < b.length && a[i] === b[i]) i++;
      return a.substring(0, i);
    }

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onstart = () => {
        lastInterim = "";
        finalText = promptInput.value;
      };

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          interim += event.results[i][0].transcript;
        }

        // Compute shared prefix (protects against Chrome rewrites)
        const common = longestCommonPrefix(lastInterim, interim);

        // New part is what's after the shared prefix in the NEW interim
        const newPart = interim.substring(common.length);

        // Append ONLY the new part
        finalText += newPart;
        promptInput.value = finalText.trim();
        autoResize(); 

        lastInterim = interim;
      };

      recognition.onerror = (e) => console.error("SpeechRecognition error:", e.error);
    }

    voiceBtn.addEventListener('click', () => {
      if (!recognition) return;

      if (!recognizing) {
        recognition.start();
        recognizing = true;
        voiceBtn.classList.add('ring-4', 'ring-aub');
      } else {
        recognition.stop();
        recognizing = false;
        voiceBtn.classList.remove('ring-4', 'ring-aub');
      }
    });

    
  </script>
  <style>
    #prompt {
  width: 100%;
  overflow-x: hidden !important;
  overflow-y: hidden !important;
  resize: none;
  white-space: pre-wrap;
  word-break: break-word;
}

  </style>

</body>
</html>
